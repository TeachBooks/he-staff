# Documentation: HE Staff Book Web Server Setup (he.citg.tudelft.nl)

This document outlines the configuration and workflow for deploying and serving the HE Staff Book website, including its main version, draft version, dynamic branch previews, and administrative index pages.

## 1. Overview

The system uses a combination of GitHub Actions, shell scripts, Docker, and Nginx to serve different versions of a Jupyter Book project.

* **Source Control:** Git repository (presumably GitHub) containing the Jupyter Book source.
* **Build:** A GitHub Actions workflow builds the Jupyter Book content when changes are pushed to branches.
* **Deployment:** The GitHub Actions workflow triggers a deployment script (`deploy-book.sh`) on the host server (`he01`).
* **Host Server (`he01`):**
    * Stores deployed web content under `/var/web_server/htdocs/`.
    * Runs Docker containers managed by `docker-compose`.
    * Contains helper scripts (`deploy-book.sh`, `update-branch-index.sh`).
* **Docker:** Runs an Nginx container (`nginx`) and potentially a backend container (`backend`).
* **Nginx:** Serves the web content, routing requests to the correct directories based on the URL path.

## 2. Key Components

### 2.1. Nginx Configuration (`/var/web_server/htdocs/default.conf`)

This file defines how Nginx handles incoming web requests. It's mounted into the Nginx container at `/etc/nginx/conf.d/default.conf`.

* **Structure:** Contains separate `server` blocks for HTTP (port 80) and HTTPS (port 443). The HTTPS block mirrors the location logic of the HTTP block.
* **Volume Mounts (via `docker-compose.yml`):**
    * `/var/web_server/htdocs` (Host) -> `/usr/share/nginx/html` (Container Web Root)
    * `/var/web_server/htdocs/default.conf` (Host) -> `/etc/nginx/conf.d/default.conf` (Container Nginx Config)
    * SSL Certificates are also mounted.
* **Important `location` Blocks (Order Matters):**

    * `location = /`: Handles the exact root path (`/`). Serves `index.html` from the `main_book_root` directory.
        ```nginx
        location = / {
            root /usr/share/nginx/html/main_book_root;
            index index.html;
            try_files /index.html =404;
        }
        ```
    * `location = /path`: Handles requests *without* a trailing slash for known directories (`/admin`, `/draft`, `/branches`). It performs a permanent redirect (301) to add the trailing slash.
        ```nginx
        location = /admin { return 301 /admin/; }
        location = /draft { return 301 /draft/; }
        location = /branches { return 301 /branches/; }
        ```
    * `location ^~ /path/`: Handles requests *with* a trailing slash for specific, known directories. The `^~` gives these blocks high priority and stops Nginx from checking regular expression locations later.
        * `/admin/`, `/draft/`, `/branches/`: Uses `alias` to map the URL directly to the corresponding directory containing their respective `index.html` files (generated by the update script for `admin` and `branches`).
            ```nginx
            location ^~ /admin/ {
                alias /usr/share/nginx/html/admin/;
                index index.html;
                try_files $uri $uri/ =404;
            }
            # Similar blocks for /draft/ and /branches/ exist
            ```
        * `/_static/`, `/_images/`, `/_downloads/`, `/some_content/`: Uses `root` to serve files from within the `main_book_root` directory. `^~` ensures these are handled correctly and not misinterpreted as dynamic branches.
            ```nginx
            location ^~ /_static/ {
                root /usr/share/nginx/html/main_book_root;
                try_files $uri $uri/ =404;
            }
            # Similar blocks for /_images/, /_downloads/, /some_content/ exist
            ```
    * `location /api`: Proxies requests starting with `/api` to the backend service defined in the `upstream backend` block.
        ```nginx
        location /api {
            proxy_pass http://backend;
            # ... proxy headers ...
        }
        ```
    * `location ~ ^/([^/]+)/`: Handles requests for **dynamic branches** (e.g., `/test-branch/`) that were *not* matched by any preceding `^~` block. **Crucially, this only matches paths with a trailing slash.** It uses `root /usr/share/nginx/html;` so that a request for `/test-branch/index.html` looks for the file at `/usr/share/nginx/html/test-branch/index.html` inside the container.
        ```nginx
        location ~ ^/([^/]+)/ {
            set $branch_path $1;
            root /usr/share/nginx/html; # Root for branches
            index index.html;
            try_files $uri $uri/ =404;
        }
        ```
    * `location /`: This is the final fallback block. It catches any request not handled by the blocks above (e.g., `/intro.html`). It serves content from the main book directory.
        ```nginx
        location / {
            root /usr/share/nginx/html/main_book_root;
            try_files $uri $uri/ =404;
        }
        ```
    * **Important Note on Redirects:** The attempt to automatically redirect dynamic branch paths *without* a trailing slash (e.g., `/test-branch` -> `/test-branch/`) was removed due to limitations and errors with Nginx `if` conditions. **Therefore, dynamic branches MUST be accessed with a trailing slash.**

### 2.2. Deployment Script (`/var/web_server/deploy-book.sh`)

* **Trigger:** Called by the GitHub Actions workflow upon successful book build.
* **Inputs:** Receives the target `BRANCH` name and the `CONTENT_SOURCE_DIR` (temporary path where the built book artifact was extracted).
* **Actions:**
    * Determines the target deployment directory on the host based on the branch name (e.g., `/var/web_server/htdocs/main_book_root` for `main`, `/var/web_server/htdocs/draft` for `draft`, `/var/web_server/htdocs/test-branch` for `test-branch`).
    * Cleans the target directory (if it exists).
    * Copies the built book content from `CONTENT_SOURCE_DIR` to the target directory using `rsync`.
    * **Special `main` branch handling:** Also copies content from a predefined `ADMIN_SOURCE_DIR` (e.g., "frontend") to `/var/web_server/htdocs/admin`.
    * Sets permissions (`chmod -R 755`) on the deployed directories.
    * **Calls the index update script:** Executes `/var/web_server/update-branch-index.sh` at the end.

### 2.3. Index Update Script (`/var/web_server/update-branch-index.sh`)

* **Trigger:** Called by `deploy-book.sh` after content deployment.
* **Purpose:** To automatically generate listing pages (`index.html`) for the `/admin/` and `/branches/` URLs, showing currently deployed branches.
* **Actions:**
    * Defines the host web root (`HOST_WEB_ROOT="/var/web_server/htdocs"`).
    * Defines the output file paths on the host (`ADMIN_INDEX_FILE`, `BRANCHES_INDEX_FILE`).
    * Defines a list of directories/files to **exclude** when scanning for branches (`EXCLUDE_ITEMS`). **This list must be kept up-to-date** if new non-branch items are added directly under `/var/web_server/htdocs`.
        ```bash
        # Example (update as needed!)
        EXCLUDE_ITEMS=("main_book_root" "admin" "draft" "branches" "default.conf" "he" "static" "figures" "book" "frontend" "backend")
        ```
    * Scans the `HOST_WEB_ROOT` for directories.
    * Filters out items present in the `EXCLUDE_ITEMS` list.
    * Stores the remaining directory names (assumed to be branches).
    * Generates the HTML content for `$ADMIN_INDEX_FILE`, including fixed links to `/` and `/draft/`, a link to `/branches/`, and a dynamic list of links to `/<branch_name>/`.
    * Generates the HTML content for `$BRANCHES_INDEX_FILE`, including fixed links to `/`, `/admin/`, `/draft/`, and the same dynamic list of links to `/<branch_name>/`.
    * Ensures the target directories (`admin`, `branches`) exist.
    * Writes the generated HTML to the respective `index.html` files, overwriting previous versions.
    * **Sets file permissions to `644`** on the generated `index.html` files using `chmod 644` to ensure the Nginx container user can read them.

### 2.4. Docker Setup (`/var/web_server/docker-compose/docker-compose.yml`)

* Manages the `nginx` and `backend` containers.
* **Crucial Volume Mounts for `nginx` service:**
    * `/var/web_server/htdocs:/usr/share/nginx/html`: Maps the host web root (where scripts deploy content and generate indexes) to the container's web root (where Nginx serves from).
    * `/var/web_server/htdocs/default.conf:/etc/nginx/conf.d/default.conf`: Mounts the Nginx configuration file into the container.
    * `/var/web_server/htdocs/he/config/certs:/var/web_server/htdocs/he/config/certs`: Mounts the directory containing SSL certificates.

## 3. Workflow Summary

1.  Developer pushes changes to a branch in the Git repository.
2.  GitHub Actions workflow triggers, builds the Jupyter Book artifact.
3.  GitHub Actions connects to the host server (`he01`) and calls `/var/web_server/deploy-book.sh` with the branch name and artifact path.
4.  `deploy-book.sh` determines the target host directory, copies the book content, and sets permissions.
5.  `deploy-book.sh` calls `/var/web_server/update-branch-index.sh`.
6.  `update-branch-index.sh` scans `/var/web_server/htdocs`, generates the `admin/index.html` and `branches/index.html` files with updated branch lists and correct permissions.
7.  User accesses `https://he.citg.tudelft.nl/`.
8.  Nginx (via Docker) receives the request.
9.  Based on the URL path and the `default.conf` rules, Nginx serves the appropriate content from `/usr/share/nginx/html` (which is mapped to `/var/web_server/htdocs` on the host).
    * `/` -> serves `main_book_root/index.html`.
    * `/admin` -> redirects to `/admin/`.
    * `/admin/` -> serves `admin/index.html` (dynamically generated).
    * `/branches` -> redirects to `/branches/`.
    * `/branches/` -> serves `branches/index.html` (dynamically generated).
    * `/test-branch/` -> serves `test-branch/index.html`.
    * `/test-branch` -> results in a 404 (requires trailing slash).
    * `/_static/...` -> serves files from `main_book_root/_static/`.

## 4. Maintenance Notes

* **Branch Index Exclusions:** If new directories are created directly under `/var/web_server/htdocs` that are *not* related to deployed branches (e.g., a new tool, another static site), they **must** be added to the `EXCLUDE_ITEMS` array in `/var/web_server/update-branch-index.sh` to prevent them from appearing in the `/admin/` and `/branches/` listings.
* **Trailing Slashes:** Remember that dynamically deployed branches (e.g., `test-branch`) **require a trailing slash** in the URL (`/test-branch/`) to be accessed correctly due to Nginx configuration limitations. Known paths like `/admin`, `/draft`, and `/branches` handle both cases automatically.
* **File Permissions:** Permissions are primarily handled by `deploy-book.sh` (755 for directories) and `update-branch-index.sh` (644 for generated index files). If permission issues arise, check these scripts and the ownership of files/directories under `/var/web_server/htdocs`. Ensure the user running the deployment script has the necessary permissions to write files and directories within `/var/web_server/htdocs` and execute the scripts.
* **Key Files:**
    * Nginx Config: `/var/web_server/htdocs/default.conf` (Host)
    * Deployment Script: `/var/web_server/deploy-book.sh` (Host)
    * Index Update Script: `/var/web_server/update-branch-index.sh` (Host)
    * Docker Compose: `/var/web_server/docker-compose/docker-compose.yml` (Host, assumed location)
    * Deployed Content Root: `/var/web_server/htdocs/` (Host)